<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Sharing</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 600px; margin: auto; }
        .box { border: 1px solid #ccc; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .progress-bar { width: 100%; background-color: #f3f3f3; border-radius: 5px; overflow: hidden; height: 20px; }
        .progress-fill { height: 100%; background-color: #4caf50; width: 0%; transition: width 0.3s; }
        .btn { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px 0; }
        .btn:disabled { background-color: #999; }
        .info { margin: 10px 0; }
    </style>
</head>
<body>
<div class="container">
    <h2>Welcome, {{ user.username }}</h2>

    <div class="box">
        <h3>Pairing</h3>
        {% if not partner %}
            <button class="btn" onclick="generateKey()">Generate My Pairing Key</button>
            <p><strong>My Key:</strong> <span id="myKey"></span></p>

            <form id="pairForm">
                <label>Enter Partner's Pairing Key:</label>
                <input type="text" name="pairing_key" required>
                <button type="submit" class="btn">Pair</button>
            </form>
            <div id="pairStatus" class="info"></div>
        {% else %}
            <p><strong>Paired with:</strong> {{ partner.username }}</p>
            <p><strong>Partner IP:</strong> {{ partner.local_ip }}</p>
        {% endif %}
    </div>

    {% if partner %}
    <div class="box">
        <h3>Send File</h3>
        <form id="sendForm">
            <input type="file" name="file" required>
            <button type="submit" class="btn">Send</button>
        </form>

        <h3>Receive File</h3>
        <form id="receiveForm">
            <label>Save to folder:</label>
            <input type="text" name="save_dir" placeholder="e.g., received_files" required>
            <button type="submit" class="btn">Receive</button>
        </form>

        <h4>Status: <span id="status">Idle</span></h4>
        <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
    </div>
    {% endif %}
</div>

<script>
function generateKey() {
    $.post("/generate_key", function(data) {
        $("#myKey").text(data.pairing_key);
    });
}

$("#pairForm").on("submit", function(e) {
    e.preventDefault();
    const key = $(this).find("input[name='pairing_key']").val();

    $.ajax({
        url: "/pair",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({ pairing_key: key }),
        success: function(res) {
            $("#pairStatus").text("Paired with " + res.partner_username + " (" + res.partner_ip + ")");
            location.reload();
        },
        error: function(err) {
            $("#pairStatus").text("Pairing failed.");
        }
    });
});

$("#sendForm").on("submit", function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    $.ajax({
        url: "/start_send",
        method: "POST",
        data: formData,
        contentType: false,
        processData: false,
        success: function(res) {
            $("#status").text("Sending...");
            trackProgress();
        }
    });
});

$("#receiveForm").on("submit", function(e) {
    e.preventDefault();
    const saveDir = $(this).find("input[name='save_dir']").val();

    $.ajax({
        url: "/start_receive",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({ save_dir: saveDir }),
        success: function(res) {
            $("#status").text("Receiving...");
            trackProgress();
        }
    });
});

function trackProgress() {
    const interval = setInterval(function() {
        $.get("/progress", function(data) {
            if (data.status) {
                $("#status").text(data.status.charAt(0).toUpperCase() + data.status.slice(1));
                $("#progressBar").css("width", data.progress + "%");

                if (data.status === "done" || data.status === "error") {
                    clearInterval(interval);
                }
            }
        });
    }, 1000);
}
</script>
</body>
</html>
